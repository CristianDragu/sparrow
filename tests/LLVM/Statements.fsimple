//!! -t ""
nodelist{

    backendcode{
"@.str = private unnamed_addr constant [4 x i8] c\"15\\0A\\00\", align 1"
"@.fmtInt = private unnamed_addr constant [4 x i8] c\"%d\\0A\\00\", align 1"
""
"define void @writeLnInt(i32 %val) {"
"  %1 = call i32 (i8*, ...)* @printf(i8* getelementptr inbounds ([4 x i8]* @.fmtInt, i32 0, i32 0), i32 %val)"
"  ret void"
"}"
""
"define i32 @mul(i32 %x, i32 %y) {"
"  %1 = mul i32 %x,%y"
"  ret i32 %1"
"}"
""
"define i32 @sub(i32 %x, i32 %y) {"
"  %1 = sub i32 %x,%y"
"  ret i32 %1"
"}"
""
"define i1 @equal(i32 %x, i32 %y) {"
"  %1 = icmp eq i32 %x,%y"
"  ret i1 %1"
"}"
""
"define i1 @greater(i32 %x, i32 %y) {"
"  %1 = icmp sgt i32 %x,%y"
"  ret i1 %1"
"}"
""
"define i32 @main(i32 %argc, i8** %argv) nounwind uwtable {"
"  %1 = alloca i32, align 4"
"  %2 = alloca i32, align 4"
"  %3 = alloca i8**, align 8"
"  store i32 0, i32* %1"
"  store i32 %argc, i32* %2, align 4"
"  store i8** %argv, i8*** %3, align 8"
"  %4 = load i8*** %3, align 8"
"  %5 = getelementptr inbounds i8** %4, i64 1"
"  %6 = load i8** %5"
"  %7 = call i32 @atoi(i8* %6) nounwind readonly"
"  call void @test(i32 %7)"
"  ret i32 0"
"}"
""
"declare i32 @atoi(i8*) nounwind readonly"
"declare i32 @printf(i8*, ...)"
"declare void @test(i32)"
    }
    
    class { Int
        autoct
        propStr("nativeName", "i32")
    }
    
    class { Bool
        autoct
        propStr("nativeName", "u1")
    }
    
    function(writeLnInt, params(var(val,Int)), void)
    function(mul, params(var(x,Int),var(y,Int)), Int)
    function(sub, params(var(x,Int),var(y,Int)), Int)
    function(equal, params(var(x,Int),var(y,Int)), Bool)
    function(greater, params(var(x,Int),var(y,Int)), Bool)
    
    function(factorial, params(var(n,Int)), Int, localspace{
        if(funCall(equal, memLoad(varRef(n)), ctValueBin(Int, "00 00 00 00")),
            return(ctValueBin(Int, "01 00 00 00")),
            return(funCall(mul, 
                memLoad(varRef(n)),
                funCall(factorial, funCall(sub, memLoad(varRef(n)), ctValueBin(Int, "01 00 00 00")))
            ))
        )
        return(ctValueBin(Int, "00 00 00 00"))
    })
    
    function (testIf, params(var(n,Int)), void, localSpace{
        if(funCall(equal, memLoad(varRef(n)), ctValueBin(Int, "00 00 00 00")),
            funCall(writeLnInt, ctValueBin(Int, "fe 00 00 00")),
            localSpace {
                funCall(testIf, funCall(sub, memLoad(varRef(n)), ctValueBin(Int, "01 00 00 00")))
                funCall(writeLnInt, memLoad(varRef(n)))
            }
        )
        if(funCall(equal, memLoad(varRef(n)), ctValueBin(Int, "02 00 00 00")),
            funCall(writeLnInt, ctValueBin(Int, "fd 00 00 00"))
        )
        return
    })

    function (testWhile, params(var(n,Int)), void, localSpace{
        funCall(writeLnInt, ctValueBin(Int, "ff 00 00 00"))
        localVar(i, Int)
        // while i > 0
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            localSpace {
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
            },
            localSpace {
                // Decrement i
                memStore(funCall(sub, memLoad(varRef(i)), ctValueBin(Int, "01 00 00 00")), varref(i))
            }
        )

        // while i > 0, no step
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            localSpace {
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
                // Decrement i
                memStore(funCall(sub, memLoad(varRef(i)), ctValueBin(Int, "01 00 00 00")), varref(i))
            }
        )

        // while i > 0, only step
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            nop,
            localSpace {
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
                // Decrement i
                memStore(funCall(sub, memLoad(varRef(i)), ctValueBin(Int, "01 00 00 00")), varref(i))
            }
        )

        return
    })

    function (testWhile2, params(var(n,Int)), void, localSpace{
        funCall(writeLnInt, ctValueBin(Int, "ff 00 00 00"))
        localVar(i, Int)
        // while i > 0, with break
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            localSpace {
                // If i == 2 break
                if(funCall(equal, memLoad(varRef(i)), ctValueBin(Int, "02 00 00 00")),
                    break
                )
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
            },
            localSpace {
                // Decrement i
                memStore(funCall(sub, memLoad(varRef(i)), ctValueBin(Int, "01 00 00 00")), varref(i))
            }
        )
        // while i > 0, with continue
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            localSpace {
                // If i == 2 continue
                if(funCall(equal, memLoad(varRef(i)), ctValueBin(Int, "02 00 00 00")),
                    continue
                )
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
            },
            localSpace {
                // Decrement i
                memStore(funCall(sub, memLoad(varRef(i)), ctValueBin(Int, "01 00 00 00")), varref(i))
            }
        )
        // while i > 0, with break in step
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            localSpace {
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
            },
            localSpace {
                // Just break
                break
            }
        )
        return
    })

    function (testReturn, params(var(n,Int)), void, localSpace{
        funCall(writeLnInt, ctValueBin(Int, "ff 00 00 00"))
        localVar(i, Int)
        // while i > 0, with return
        memStore(memLoad(varRef(n)), varref(i))
        while(funCall(greater, memLoad(varRef(i)), ctValueBin(Int, "00 00 00 00")),
            localSpace {
                // If i == 2 break
                if(funCall(equal, memLoad(varRef(i)), ctValueBin(Int, "02 00 00 00")),
                    return
                )
                // Print i
                funCall(writeLnInt, memLoad(varRef(i)))
            },
            localSpace {
                // Decrement i
                memStore(funCall(sub, memLoad(varRef(i)), ctValueBin(Int, "01 00 00 00")), varref(i))
            }
        )
        return
    })

    function(test, params(var(x,Int)), void, localspace{
        funCall(testIf, memLoad(varRef(x)))
        funCall(testWhile, memLoad(varRef(x)))
        funCall(testWhile2, memLoad(varRef(x)))
        funCall(testReturn, memLoad(varRef(x)))
        funCall(writeLnInt, funCall(factorial, memLoad(varRef(x))))
        return
    })
}

/*<<<Running(5)
254
1
2
253
3
4
5
255
5
4
3
2
1
5
4
3
2
1
5
4
3
2
1
255
5
4
3
5
4
3
1
5
255
5
4
3
120
>>>*/
